#!/bin/sh
# Agent Guardrails Post-Commit Hook
# Records commit information and updates agent tracking

echo "ðŸ“Š Running Agent Guardrails Post-Commit Updates..."

# Get commit information
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_SHORT=$(git rev-parse --short HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B)
COMMIT_AUTHOR=$(git log -1 --pretty=%an)
COMMIT_TIMESTAMP=$(git log -1 --pretty=%ci)

echo "ðŸ“ Commit: $COMMIT_SHORT - $COMMIT_MESSAGE"

# Create post-commit snapshot
CURRENT_SESSION=$(date +%s)-$(openssl rand -hex 3)
if [ -f ".claude/guardrails/file-state-monitor.js" ]; then
    echo "ðŸ“¸ Creating post-commit file snapshot..."
    node .claude/guardrails/file-state-monitor.js snapshot "post-commit-$CURRENT_SESSION" > /dev/null 2>&1
fi

# Log commit in agent tracking system
if [ -f ".claude/guardrails/execution-tracker.js" ]; then
    echo "ðŸ“‹ Recording commit in agent tracking..."
    
    # Create a pseudo-session for this commit if there were recent agent activities
    RECENT_REPORTS=$(node .claude/guardrails/execution-tracker.js report 2>/dev/null | jq length 2>/dev/null || echo "0")
    
    if [ "$RECENT_REPORTS" -gt 0 ]; then
        # There were recent agent sessions, associate this commit
        echo "ðŸ”— Associating commit with recent agent activity"
    fi
fi

# Update reliability metrics with commit success
if [ -f ".claude/guardrails/reliability-metrics.js" ]; then
    echo "ðŸ“ˆ Recording successful commit in reliability metrics..."
    
    # Record a successful "commit-integration" session
    SESSION_DATA=$(cat <<EOF
{
  "sessionId": "commit-$COMMIT_SHORT",
  "agentType": "git-integration",
  "success": true,
  "score": 100,
  "timestamp": "$COMMIT_TIMESTAMP",
  "executionTime": 1000,
  "toolCallsCount": 1,
  "claimsCount": 1,
  "verifiedClaims": 1,
  "phantomClaims": 0,
  "issues": []
}
EOF
)
    
    echo "$SESSION_DATA" | node .claude/guardrails/reliability-metrics.js record "$(echo "$SESSION_DATA" | tr -d '\n')" > /dev/null 2>&1
fi

# Clean up old snapshots (keep last 20)
if [ -f ".claude/guardrails/file-state-monitor.js" ]; then
    echo "ðŸ§¹ Cleaning up old snapshots..."
    node .claude/guardrails/file-state-monitor.js cleanup 20 > /dev/null 2>&1
fi

echo "âœ… Agent Guardrails post-commit updates completed"